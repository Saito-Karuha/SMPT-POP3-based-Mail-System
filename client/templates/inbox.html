{% extends "layout.html" %}

{% block title %}æ”¶ä»¶ç®±{% endblock %}

{% block content %}
<div class="email-container">
  <div class="sidebar">
        <a href="{{ url_for('compose') }}" class="btn compose-btn"> âœ‰ å†™é‚®ä»¶</a>
        <li class="active"><a href="{{ url_for('inbox') }}" class="btn compose-btn">ğŸ“¥ æ”¶ä»¶ç®±</a></li>
        <a href="{{ url_for('sent') }}" class="btn compose-btn">ğŸ“¤ å·²å‘é€</a>
        <a href="{{ url_for('trash') }}" class="btn compose-btn">ğŸ—‘ï¸ åƒåœ¾ç®±</a>
  </div>

  <section class="email-list">
    <h2>æ”¶ä»¶ç®±</h2>
    <div class="search-box">
      <input type="text" placeholder="æœç´¢é‚®ä»¶...">
    </div>
    <table>
      <thead>
        <tr>
          <th width="25%">å‘ä»¶äºº</th>
          <th width="45%">ä¸»é¢˜</th>
          <th width="20%">æ—¥æœŸ</th>
        </tr>
      </thead>
      <tbody>
        {% for email in emails %}
        <tr data-id="{{ email.id }}" style="cursor: pointer;" onclick="window.location.href='{{ url_for('view_email') }}?path={{ email.path | urlencode }}'">
          <td>{{ email.from }}</td>
          <td>{{ email.subject|truncate(50) }}</td>
          <td>{{ email.date }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="4">æš‚æ— é‚®ä»¶</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // åˆ é™¤é‚®ä»¶äº‹ä»¶ç»‘å®š
  document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();

      const tr = btn.closest('tr');
      if (!tr) return;

      const emailId = tr.dataset.id;
      if (!emailId) return;

      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å°é‚®ä»¶å—ï¼Ÿ')) return;

      try {
        const response = await fetch(`/emails/${emailId}`, { method: 'DELETE' });
        if (response.ok) {
          tr.remove();
          alert('é‚®ä»¶å·²åˆ é™¤');
        } else {
          alert('åˆ é™¤å¤±è´¥');
        }
      } catch (error) {
        alert('åˆ é™¤å‡ºé”™: ' + error.message);
      }
    });
  });

  // æœç´¢è¿‡æ»¤åŠŸèƒ½
  const searchInput = document.querySelector('.search-box input');
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      const term = searchInput.value.trim().toLowerCase();
      document.querySelectorAll('tbody tr').forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(term) ? '' : 'none';
      });
    });
  }
});
</script>
{% endblock %}
